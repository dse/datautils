#!/usr/bin/env perl
use warnings;
use strict;
use open OUT => ':locale';

use JSON;
use List::Util qw(all max);

my $json = JSON->new()->pretty(1)->canonical(1)->ascii(1);

if (scalar @ARGV < 2) {
    die("not enough arguments\n");
}

my @filename;
my @object;
my $i = 0;
$/ = undef;
while (<>) {
    # seen in some JSON output by `mongoexport --jsonArray`.
    s{":\+Infinity\b}{":"<<<+Infinity>>>"}g;
    s{":\-Infinity\b}{":"<<<-Infinity>>>"}g;

    warn("parsing ...\n");
    my $object = $json->decode($_);
    push(@object, $object);
    push(@filename, $ARGV);
}

my @i;
for (my $i = 0; $i <= $#object; $i += 1) {
    if (ref $object[$i] eq 'HASH') {
        push(@i, $i);
    } else {
        warn(sprintf("%s: not an object\n", $filename[$i]));
    }
}

@object   = map { $object[$_]   } @i;
@filename = map { $filename[$_] } @i;
if (scalar @object < 2) {
    die("not enough objects\n");
}

my $cmp = compare(@object);
print($json->encode($cmp));

sub compare {
    my (@obj) = @_;
    my %k;

    my @definedObj = grep { defined $_ } @obj;
    return unless scalar @definedObj;

    return unless scalar @definedObj;
    if (all { ref $_ eq 'HASH' } @definedObj) {
        my %k;
        foreach my $obj (@definedObj) {
            foreach my $k (keys %$obj) {
                $k{$k} = 1;
            }
        }
        my @k = sort keys %k;
        my $cmp = {};
        foreach my $k (@k) {
            my @cmp = map { defined $_ ? $_->{$k} : undef } @obj;
            $cmp->{$k} = compare(@cmp);
        }
        return $cmp;
    }
    if (all { ref $_ eq 'ARRAY' } @definedObj) {
        my $count = max map { scalar @$_ } @definedObj;
        my $cmp = [];
        for (my $i = 0; $i < $count; $i += 1) {
            my @cmp = map { defined $_ ? $_->[$i] : undef } @obj;
            if (grep { defined $_ } @cmp) {
                $cmp->[$i] = compare(@cmp);
            } else {
                $cmp->[$i] = undef;
            }
        }
        return $cmp;
    }
    if (all { ref $_ eq '' } @definedObj) {
        return [ @obj ];
    }
    return;
}
